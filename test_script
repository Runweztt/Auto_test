#!/bin/bash

# =============================================================================
# Test Script for setup_project.sh
# This script demonstrates various test cases
# =============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}   SETUP SCRIPT TEST SUITE${NC}"
echo -e "${BLUE}========================================${NC}\n"

# Test 1: Check if script exists and is executable
echo -e "${YELLOW}Test 1: Script Existence and Permissions${NC}"
if [ -f "setup_project.sh" ]; then
    echo -e "${GREEN}✓ setup_project.sh found${NC}"
    if [ -x "setup_project.sh" ]; then
        echo -e "${GREEN}✓ Script is executable${NC}"
    else
        echo -e "${RED}✗ Script is not executable${NC}"
        echo -e "${YELLOW}  Run: chmod +x setup_project.sh${NC}"
    fi
else
    echo -e "${RED}✗ setup_project.sh not found${NC}"
    exit 1
fi
echo ""

# Test 2: Verify Python 3 is available
echo -e "${YELLOW}Test 2: Python 3 Availability${NC}"
if command -v python3 &> /dev/null; then
    VERSION=$(python3 --version)
    echo -e "${GREEN}✓ Python 3 is installed: ${VERSION}${NC}"
else
    echo -e "${YELLOW}! Python 3 not found - script will show warning${NC}"
fi
echo ""

# Test 3: Check for required commands
echo -e "${YELLOW}Test 3: Required Commands${NC}"
COMMANDS=("tar" "sed" "mkdir" "rm" "cat" "read")
ALL_PRESENT=true

for cmd in "${COMMANDS[@]}"; do
    if command -v "$cmd" &> /dev/null; then
        echo -e "${GREEN}✓ $cmd available${NC}"
    else
        echo -e "${RED}✗ $cmd not found${NC}"
        ALL_PRESENT=false
    fi
done

if [ "$ALL_PRESENT" = true ]; then
    echo -e "${GREEN}✓ All required commands are available${NC}"
else
    echo -e "${RED}✗ Some required commands are missing${NC}"
fi
echo ""

# Test 4: Demonstrate normal execution (automated)
echo -e "${YELLOW}Test 4: Automated Normal Execution${NC}"
echo -e "${BLUE}Running automated test with input 'test_auto'${NC}"
echo -e "test_auto\nn\n" | ./setup_project.sh > /tmp/test_output.log 2>&1

if [ -d "attendance_tracker_test_auto" ]; then
    echo -e "${GREEN}✓ Project directory created${NC}"
    
    # Verify structure
    if [ -f "attendance_tracker_test_auto/attendance_checker.py" ]; then
        echo -e "${GREEN}✓ attendance_checker.py exists${NC}"
    fi
    
    if [ -d "attendance_tracker_test_auto/Helpers" ]; then
        echo -e "${GREEN}✓ Helpers directory exists${NC}"
    fi
    
    if [ -d "attendance_tracker_test_auto/reports" ]; then
        echo -e "${GREEN}✓ reports directory exists${NC}"
    fi
    
    if [ -f "attendance_tracker_test_auto/Helpers/config.json" ]; then
        echo -e "${GREEN}✓ config.json exists${NC}"
        echo -e "${BLUE}Config content:${NC}"
        cat attendance_tracker_test_auto/Helpers/config.json | head -3
    fi
    
    # Clean up
    rm -rf attendance_tracker_test_auto
    echo -e "${BLUE}Test directory cleaned up${NC}"
else
    echo -e "${RED}✗ Project directory not created${NC}"
fi
echo ""

# Test 5: Archive functionality demonstration
echo -e "${YELLOW}Test 5: Archive Creation Test${NC}"
echo -e "${BLUE}This test requires manual Ctrl+C - demonstrating concept only${NC}"
echo -e "To test archive creation:"
echo -e "  1. Run: ./setup_project.sh"
echo -e "  2. Enter: archive_test"
echo -e "  3. Press: Ctrl+C"
echo -e "  4. Verify: attendance_tracker_archive_test_archive.tar.gz exists"
echo -e "  5. Verify: attendance_tracker_archive_test directory is removed"
echo ""

# Test 6: Check script contains required functions
echo -e "${YELLOW}Test 6: Required Functions Present${NC}"
FUNCTIONS=("cleanup_on_interrupt" "validate_python" "update_config" "create_directory_structure" "verify_structure")
ALL_FUNCTIONS_PRESENT=true

for func in "${FUNCTIONS[@]}"; do
    if grep -q "^${func}()" setup_project.sh; then
        echo -e "${GREEN}✓ Function ${func}() found${NC}"
    else
        echo -e "${RED}✗ Function ${func}() not found${NC}"
        ALL_FUNCTIONS_PRESENT=false
    fi
done

if [ "$ALL_FUNCTIONS_PRESENT" = true ]; then
    echo -e "${GREEN}✓ All required functions are present${NC}"
else
    echo -e "${RED}✗ Some required functions are missing${NC}"
fi
echo ""

# Test 7: Check for trap implementation
echo -e "${YELLOW}Test 7: Signal Trap Implementation${NC}"
if grep -q "trap.*SIGINT" setup_project.sh; then
    echo -e "${GREEN}✓ SIGINT trap found${NC}"
else
    echo -e "${RED}✗ SIGINT trap not found${NC}"
fi
echo ""

# Test 8: Check for sed usage
echo -e "${YELLOW}Test 8: Stream Editing (sed) Implementation${NC}"
if grep -q "sed" setup_project.sh; then
    echo -e "${GREEN}✓ sed command found in script${NC}"
    SED_COUNT=$(grep -c "sed" setup_project.sh)
    echo -e "${BLUE}  Number of sed usages: ${SED_COUNT}${NC}"
else
    echo -e "${RED}✗ sed command not found${NC}"
fi
echo ""

# Summary
echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}   TEST SUITE COMPLETE${NC}"
echo -e "${BLUE}========================================${NC}\n"

echo -e "${GREEN}Manual Tests Remaining:${NC}"
echo -e "1. Run script interactively with custom thresholds"
echo -e "2. Test Ctrl+C archive creation"
echo -e "3. Test overwriting existing directory"
echo -e "4. Run the created attendance tracker"
echo ""

echo -e "${BLUE}To run the script manually:${NC}"
echo -e "  ./setup_project.sh"
echo ""
